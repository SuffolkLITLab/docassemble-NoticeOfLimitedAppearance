include:
  - docassemble.MAVirtualCourt:basic-questions.yml
---
comment: |
  Predefine some variables we need
code: |
  allowed_courts = [    
      "Boston Municipal Court",
      "District Court",
      "Housing Court",
      "Land Court",
      "Probate and Family Court",
      "Superior Court",
       ] 
  preferred_court = [    
      "Boston Municipal Court",
      "District Court",
      "Housing Court",
      "Land Court",
      "Probate and Family Court",
      "Superior Court",
       ] 
  interview_presets = True
---  
code: |       
  #final_form_to_file = notice_of_limited_appearance
  #form_to_file_no_cover = notice_of_limited_appearance
  final_form = notice_of_limited_appearance
---
objects:  
  - clients: PeopleList.using(auto_gather=False)
---
id: interview order
mandatory: True
code: |
  interview_presets
  basic_questions_intro_screen
  ask_court_question
  #docket_number_question 
  docket_numbers.there_are_any = True
  docket_numbers.gather() 
  plaintiff_name
  defendant_name
  users[0].name.first
  user_needs_interpreter
  represented_party
  clients.gather()
  if not need_motion:
    set_empty_motion_details
  if not need_hearing:
    set_empty_hearing_details
  if not need_adr:
    set_empty_adr_details
  if not need_other_court_event:
    set_empty_other_court_event_details
  if not need_trial:
    set_empty_trial_details
  if not need_others:
    set_empty_others_details
  firm_agency_name
  bbo_number
  users[0].address.address
  users[0].address.unit
  users[0].address.city
  users[0].address.state
  users[0].address.zip
  users[0].mobile_number
  users[0].phone_number
  users[0].fax
  users[0].email
  preview_screen
  agrees_to_certify
  users[0].signature
  attorney_signature_date = today().format("MM-dd-yyyy")
  signature_fields = [] 
  for client in clients:
    signature_fields.append(client.instanceName + '.signature')
  basic_questions_signature_flow
  signature_date = today().format("MM-dd-yyyy") 
  #notice_of_limited_appearance.docx = True 
  download
---
sets: set_empty_motion_details
scan for variables: False
code: |
  need_motion_details = ""
  need_motion_date = ""
  
  set_empty_motion_details = True
---
sets: set_empty_hearing_details
scan for variables: False
code: |
  need_hearing_details = ""
  need_hearing_date = ""
  
  set_empty_hearing_details = True
---
sets: set_empty_adr_details
scan for variables: False
code: |
  need_adr_details = ""
  need_adr_date = ""
  
  set_empty_adr_details = True
---
sets: set_empty_other_court_event_details
scan for variables: False
code: |
  need_other_court_event_details = ""
  need_other_court_event_date = ""
  
  set_empty_other_court_event_details = True
---
sets: set_empty_trial_details
scan for variables: False
code: |
  need_trial_details = ""
  need_trial_date = ""
  
  set_empty_trial_details = True
---
sets: set_empty_others_details
scan for variables: False
code: |
  need_others_details = ""
  need_others_date = ""
  
  set_empty_others_details = True
---
id: basic questions intro screen
question: |
  Ask the Court for Notice of Limited Apearance: Mass Access Project
subquestion: |
 
  This website can help you complete and file court forms in 3 steps:
  
  Step 1. Answer questions to prefill your forms.  
  Step 2. Review the completed forms.  
  Step 3. Email the forms to the court using this secure website and save copies
  for yourself for later reference.  
  
  If you have questions about this form or the court process, 
  call the Trial Courtâ€™s Emergency HelpLine:  
  833-91-COURT (833-912-6878)  
  Monday-Friday  
  8:30am - 4:30pm

  % if chat_partners_available().help:
  Live help is currently available in this interview. Click the speech bubble
  (:comment-alt:) in the navigation bar to connect to a live advocate for help.
  % endif

fields:
  - To continue, please read the [terms of use](https://massaccess.suffolklitlab.org/privacy/): acknowledged_information_use
    datatype: checkboxes
    none of the above: False    
    minlength: 1
    choices:
      - I accept the terms of use.
    validation messages:
      minlength: |
        You cannot continue unless you agree to the terms of use.        
continue button field: basic_questions_intro_screen
---
id: court question
question: |
  What court is the case being heard in?
subquestion: |
  The case can be heard in these courts: ${comma_and_list(allowed_courts)}.
  The local court can be found by using the [Courthouse Locator](https://www.mass.gov/guides/find-a-courthouse-serving-you).
fields:
  - Court name: courts[0]
    datatype: object
    choices: macourts.filter_courts(allowed_courts)
continue button field: ask_court_question
---
id: docket number
#continue button field: docket_number_question
question: |
  What is the docket number for this case?
subquestion: |
  If there are multiple docket numbers on this form, you can click "${word("Add another")}"
  to add more than one.
list collect: True
fields:
  - no label: docket_numbers[i]
    required: True
---
id: parties question
question: |
  Who are the parties in this case?
fields:
  - Name of Plaintiff/Petitoner: plaintiff_name
    required: True
  - Name of Defendant/Respondent: defendant_name
    required: True
---
id: attorney name
question:  |
  What is your name?
fields:
  - First Name: users[0].name.first
  - Middle Name: users[0].name.middle
    required: False
  - Last Name: users[0].name.last
  - Suffix: users[0].name.suffix
    code: |
      name_suffix()
    required: False 
---
id: interpreter question
question: |
  Does your client need an interpreter?
subquestion: |
  Your client has the right to an interpreter. 
  
  If they are not 100% confident about speaking English ask for an interpreter. 
  
  If there is a chance they may not understand everything that is said in English, or
  other people may not be able to understand them, then ask.
  
  They do not have to speak only through the interpeter, but they may have one if they   need one.
fields:
  - Is an interpreter required?: user_needs_interpreter
    datatype: yesnoradio
  - Preferred language: user_preferred_language 
    show if: user_needs_interpreter
---
id: representation question
question: |
  Which party are you representing?
fields: 
  - Answer: represented_party
    input type: radio
    choices:
      - Plaintiff/Petitioner: Plaintiff
      - Defendant/Respondent: Defendant
---
code: |
  clients.clear() 
  clients.appendObject()
  if represented_party == "Plaintiff":  
    clients[0].name.first = plaintiff_name 
  else: 
    clients[0].name.first = defendant_name
  clients.gathered = True
---
code: |
  clients.there_is_another = False
  users.there_is_another = False
---
code: |
  clients.there_are_any = True
---
id: events or issues
question: |
  What court event(s) or issue(s) are you representing your client in?
subquestion: |
  You and your Client have both signed a written agreement for you to represent your client on a limited basis in the following court event(s) or discrete issue(s) as described below (list event date where applicable).
fields:
  - Motion: need_motion
    datatype: yesno
    required: False
  - Details about motion: need_motion_details
    show if: need_motion
  - Date: need_motion_date
    datatype: date
    required: False
    show if: need_motion
  - Hearing: need_hearing
    datatype: yesno
    required: False  
  - Details about hearing: need_hearing_details
    show if: need_hearing
  - Date: need_hearing_date
    datatype: date
    required: False
    show if: need_hearing 
  - ADR: need_adr
    datatype: yesno
    required: False 
  - Details about ADR: need_adr_details
    show if: need_adr
  - Date: need_adr_date
    datatype: date
    required: False
    show if: need_adr 
  - Other Court Event: need_other_court_event
    datatype: yesno
    required: False   
  - Details about Other Court Event: need_other_court_event_details
    show if: need_other_court_event
  - Date: need_other_court_event_date
    datatype: date
    required: False
    show if: need_other_court_event  
  - Trial: need_trial
    datatype: yesno
    required: False
  - Details about trial: need_trial_details
    show if: need_trial
  - Date: need_trial_date
    datatype: date
    required: False
    show if: need_trial
  - Others (Must Specify): need_others
    datatype: yesno
    required: False
  - Details about others: need_others_details
    show if: need_others
  - Date: need_others_date
    datatype: date
    required: False
    show if: need_others
validation code: |
  if (not showifdef('need_motion') and \
      (not showifdef('need_hearing')) and \
      (not showifdef('need_adr')) and \
      (not showifdef('need_other_court_event')) and \
      (not showifdef('need_trial_details')) and \
      (not showifdef('need_others_details'))):
    validation_error(word("You need to state at least one event/issue."))
---
id: attorney certification
question: |
  Attorney Certification Notice
subquestion: |
  I certify that I have completed an approved LAR information session as required, and   that I have signed a written agreement with the Client above to provide the limited     representation in this matter as described above. 
  
  I also certify that I have served this Notice of Limited Appearance on this             Client, all counsel and all Parties not represented by counsel
fields:
  - no label: agrees_to_certify
    datatype: checkboxes
    minlength: 1
    choices:
      - Certify
    validation messages:
      minlength: |
        You cannot continue unless you check this checkbox.
---
need: agrees_to_tos
question: All done
---
id: address and fax number
question: |
  Address and Fax Number
fields:
  - Firm or Agency Name (if applicable): firm_agency_name
    required: False
  - B.B.O. Number: bbo_number
  - Street Address: users[0].address.address
  - Apt/Unit Number: users[0].address.unit
    required: False
  - City: users[0].address.city
  - State: users[0].address.state
    code: |
      states_list()
    default: MA      
  - Zip: users[0].address.zip
  - Fax Number: users[0].fax
    required: False
---
id: phone number and email
question: |
  Phone Number and Email
subquestion: |
  The court needs to be able to reach you to schedule your hearing.
  
  Include at least **one** way to reach you other than by mail.
fields:  
  - Office or Home Phone number: users[0].phone_number
  - Mobile number: users[0].mobile_number
    required: False
  - Email address: users[0].email    
    datatype: email
validation code: |
  if (not showifdef('users[0].home_number') and \
      (not showifdef('users[0].mobile_number')) and \
      (not showifdef('users[0].email'))): 
    validation_error(word("You need to provide at least one contact method."))     
---
id: preview screen
question: |
  Preview your form
subquestion: |
  Click the form below to open it in a new window.
  
  Look it over carefully. If you have any corrections, use "Back"
  to fix the mistakes.
  
  ${ form_to_sign }
continue button field: preview_screen
---
code: |
 form_to_sign = pdf_concatenate(preview_doc)
---
code: |
  #download_titles = ["notice_of_limited_appearance"]
---
attachment:
  docx template file: notice_of_limited_appearance.docx
  variable name: preview_doc
---
code: |
  final_form = pdf_concatenate(notice_of_limited_appearance)
---
attachment: 
  docx template file: notice_of_limited_appearance.docx
  variable name: notice_of_limited_appearance
---
event: review_all_sections
question: |
  Review of your answers
subquestion: |
  ${showifdef('form_to_sign')}
  % if defined('form_delivery_complete'):
  **Warning: your form has already been delivered.** Any changes you make
  will _not_ be sent to the court.
  % endif
  Click a section to revisit the answers from that section.
  % for section in section_links(nav):
  * ${section}
  % endfor
  Press "${word("Resume")}" to resume the
  interview.
buttons:
  ${word("Resume")}: continue
---
id: review before signature
need: form_to_sign
continue button field: preview_screen
question: |
  Nearly finished
subquestion: |
  You are almost done! Please click on the form below. It will open in a new window so you can review it and make sure it is correct.
  Don't forget to come back to this page to click to the final step of signing and sending the form to the court. 
   
   ${ form_to_sign }
   
progress: 95
---
#id: download form
#event: download
#comment: |
#  The attachment email screen relies on final_form_to_file being defined. This
#  will be built from the interview_metadata dictionary's contents, but if you
#  add any addenda you will want to set this in a code block somewhere that takes
#  priority over basic-questions.yml.
#decoration: file-download
#question: |
#  % if not defined('email_success') or not email_success:
#  Review, Download, and Send Form
#  % else:
#  Form delivered
#  % endif
#subquestion: |
#  % if not defined('email_success') or not email_success:
#  Thank you ${users[0]}. Your form is ready to send to the court. **It is not
#  delivered until you complete the delivery process below.**
#  1. Click the preview image below to open the form in a new window. Correct any errors using the "Make changes" button below.
#  1. Download and save or print a copy of this form for your 
#  records.
#  1. Click the "Submit to ${courts[0]}" button to send it to the court. 
#  1. You will have a chance to add instructions to the clerk and see the cover page before final delivery.
#  % else:
#  If you do not hear from the court in 1 business day, call the Trial Court's
#  Emergency HelpLine 833-91-COURT (833-912-6878).
#  The Emergency HelpLine is open:  
#  8:30am - 4:30pm,   
#  Monday - Friday.
#  % endif
#  ${ form_to_file_no_cover }  
#  
#  ${action_button_html(url_action('review_all_sections'), icon='edit', label=word("Make changes"))}
#  
#  % if not defined('email_success') or not email_success:
#    ${ action_button_html( url_action('form_delivery_complete'), id_tag="submitToCourt", label="Submit to " + str(courts[0].name), icon=send_icon, size="md", color="primary")}
#    
#  Or download/email below:
#  % else:
#    Your email has already been delivered to ${courts[0]}
#    
#  [:file-download: Download with cover page](${final_form_to_file.url_for()})    
#  % endif
#progress: 100
#attachment code: notice_of_limited_appearance
#section: download
---
id: signature of Attorney
question: |
  This form requires your signature and the signature of your client.
subquestion: | 
  You can sign below using the mouse or touchpad of your computer. By clicking "Next" you will be able to continue the interview and text your client a link to sign this form.
signature: users[0].signature
under: |
  ${users[0]}
progress: 99
---
id: date of signature by Attorney
question: |
 Dated:
fields:
  - Date: attorney_signature_date
    datatype: date
    default: ${today().format("yyyy-MM-dd")}
---
id: signature choice
decoration: file-signature
question: |
  We are almost ready to file your form. Your client will need to sign it first.
subquestion: |
  You can send this form to your client to sign if you choose the "phone" option.
field: signature_choice
buttons:  
  - Sign on a phone: phone
    image: mobile-alt
continue button field: saw_signature_choice
script: |
  <script>
    $(".da-field-buttons > div > .btn-da-custom").last().after("<br>")
    $(".da-field-buttons > div > .btn-da-custom").first().before("<br>")
  </script>
---
comment: |
  This block is shown when the user texts a link to sign a form
id: signature wait screen
#question: |
#  % if defined('tenant.signature'):
#  Thank you for signing.
#  % else:
#  Sign on your phone
#  % endif
question: |
  % if device().is_pc:
  % if defined('tenant.signature'):
  Click ${word("next")}.
  % else:
  Click ${word("next")} on this screen once your client has finished signing on their phone.
  % endif
  % else:
  You have been asked to sign this PDF. Click to review it.    
  ${form_to_sign}  
  [Make changes](${url_action('review_all_sections')})

  Click ${word("next")} on this screen when you're ready to sign.
  % endif  
field: signature_wait_screen
decoration: file-signature
---
id: signature-phone
question: |
  Text your client a link to sign this form
fields:
  - note: |
    Text a link: text_link
    datatype: yesnowide
    show if: 
      code: |
        device().is_pc
  - label: Cell phone number
    field: link_cell
    show if: text_link
    default: ${showifdef('users[0].phone_number')}
  - note: |
      Click ${word("next")} to add your signature.
    show if: 
      code: |
        not device().is_pc
help: |
  Many smartphones will automatically find the link on this screen when you use
  the camera app. The link
  may "float" up from the screen into a small icon you can click.
  If your phone does not do this, use the text option instead.
continue button field: saw_signature_qrcode
---
id: signature phone followup
question: |
  Thank you for signing. You can now close this browser on your phone.  
field: signature_phone_followup  
---
template: interview_link
content: |
  Hi, ${ users[0] }  sent you a form from MassAccess. To sign the form,
  click the link below:  
  ${interview_url()}
---
code: |
  started_on_phone = device().is_mobile
---
# Triggers some questions to ask for signatures on either desktop or mobile
# Allows sending via text/email
id: basic questions signature flow control
code: |
  if not defined('signature_fields'):
    # Not a perfect default, but typically only the user needs to sign
    # Make sure signature_fields is defined in a mandatory block
    signature_fields = ['users[0].signature']
  if started_on_phone:
    saw_signature_choice = True
    for signature in signature_fields:
      value(signature)
    # Add in logic for when we need additional signatures
  else: 
    # Three branches:
    # 1. Decided to sign on the PC
    # 2. Sent someone a link to sign the form
    # 3. Used the QR code
    saw_signature_choice
    # Branch 1: PC
    if signature_choice =='this device':
      for signature in signature_fields:
        value(signature)    
    # Check for Branch 2 or 3
    elif signature_choice == 'phone':
      saw_signature_qrcode
      # User will click next. link_cell will only be defined if they chose the texting option
      if defined('link_cell') and link_cell and task_not_yet_performed('send signature link'): 
        # They used the text option
        send_sms(task='send signature link', to=link_cell,template=interview_link)
        signature_wait_screen
        for signature in signature_fields:
          value(signature)
      else: # Branch 3: They used the QR Code. No special screen, just continue
        for signature in signature_fields:
          value(signature)
      # Show the follow-up either way
      if device().is_mobile:
        #signed = False
        #while not signed:
        #  for signature in signature_fields:
        #    signed = defined(signature) & signed
        signature_phone_followup
  basic_questions_signature_flow = True
---
id: date of signature by client
question: |
 Dated:
fields:
  - Date: signature_date
    datatype: date
    default: ${today().format("yyyy-MM-dd")}
---
id: download final form
event: download
question: |
  Your form is ready
subquestion: |
  Look over the form below.
  
  1. If it looks correct, download or email it to yourself.
  2. You still need to deliver it to the ${courts[0]}. You may be able to get help with delivery if you call
  the court's emergency help line.


  Court's emergency help line:    
  833-91-COURT (833-912-6878)  
  Monday-Friday  
  8:30am - 4:30pm
  
  ${ final_form }
attachment code: notice_of_limited_appearance